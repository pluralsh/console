name: K8s versions update
on:
  schedule:
    - cron: 0 0 * * 1-5 # At 00:00 on every day-of-week from Monday through Friday
  workflow_dispatch:
jobs:
  latest-k8s-version:
    runs-on: ubuntu-latest
    permissions:
      contents: 'write'
      id-token: 'write'
      pull-requests: 'write'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Get latest K8s version
        run: make find-k8s-version
      - name: Get current version
        id: version
        run: echo "VERSION=$(cat KUBE_VERSION)" >> "$GITHUB_OUTPUT"
      - name: Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          title: Update KUBE_VERSION to ${{ steps.version.outputs.VERSION }}
          commit-message: Update KUBE_VERSION
          branch: k8s-version-${{ steps.version.outputs.VERSION }}
          labels: chore
          base: master
  update-k8s-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: 'write'
      id-token: 'write'
      pull-requests: 'write'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: us-east-2
          role-to-assume: arn:aws:iam::312272277431:role/github-actions/console-actions
          role-session-name: plural-console
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: 'projects/${{ secrets.GOOGLE_PROJECT_ID }}/locations/global/workloadIdentityPools/console-github/providers/console-github'
          service_account: 'console-sa@pluralsh.iam.gserviceaccount.com'
          token_format: 'access_token'
          create_credentials_file: true
      - uses: 'google-github-actions/setup-gcloud@v2'
        with:
          version: '>= 363.0.0'
      - run: make find-versions
      - name: Get current date
        id: date
        run: echo "DATE=$(date +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"
      - name: Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          title: Update K8s versions
          commit-message: Update K8s versions
          branch: k8s-versions-update-${{ steps.date.outputs.DATE }}
          labels: chore
          base: master
