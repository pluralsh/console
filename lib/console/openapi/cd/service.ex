defmodule Console.OpenAPI.CD.Service do
  @moduledoc """
  OpenAPI schema for service deployments.

  A service deployment represents a reference to a service deployed from a git repo into a cluster.
  """
  use Console.OpenAPI.Base

  defschema List, "A list of service deployments", %{
    type: :object,
    description: "A paginated list of service deployments",
    properties: %{
      data: array_of(Console.OpenAPI.CD.Service)
    }
  }

  defschema %{
    type: :object,
    title: "Service",
    description: "A service deployment reference deployed from a git repo into a cluster",
    properties: timestamps(%{
      id: string(description: "Unique identifier for the service deployment"),
      name: string(description: "Name of the service"),
      namespace: string(description: "Kubernetes namespace where the service is deployed"),
      status: ecto_enum(Console.Schema.Service.Status, description: "Current status of the service deployment (e.g., stale, synced, healthy, failed, paused)"),
      sha: string(description: "Git commit SHA for the current synced revision.  This will be a helm digest if a pure helm chart as well"),
      message: string(description: "Latest commit message from the synced revision"),
      component_status: string(description: "Status message from components (e.g. unhealthy reason)"),
      templated: boolean(description: "If true, the service was deployed using a template"),
      protect: boolean(description: "If true, prevents service deletion or config edits"),
      dry_run: boolean(description: "If true, this service is running in dry-run mode"),
      interval: string(description: "Polling interval for the service reconcile loop (e.g., \"5m\")"),
      deleted_at: datetime(description: "Timestamp the service was marked for deletion, if deleted"),
      cluster_id: string(description: "ID of the cluster this service is deployed to"),
      repository_id: string(description: "ID of the git or Helm repository backing this service"),
      git: Console.OpenAPI.Git,
      helm: Console.OpenAPI.CD.HelmSpec,
      kustomize: Console.OpenAPI.CD.Kustomize,
      errors: array_of(Console.OpenAPI.CD.ServiceError, description: "List of errors generated by the deployment operator"),
      sources: array_of(Console.OpenAPI.CD.ServiceSource, description: "Additional source repositories for this service"),
      renderers: array_of(Console.OpenAPI.CD.ServiceRenderer, description: "Custom renderers for processing service manifests"),
    })
  }
end

defmodule Console.OpenAPI.CD.ServiceRenderer do
  @moduledoc """
  OpenAPI schema for service renderers.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "ServiceRenderer",
    description: "A custom renderer for processing service manifests at a specific path",
    properties: %{
      path: string(description: "Path within the repository where this renderer applies"),
      type: ecto_enum(Console.Schema.Service.RendererType, description: "Type of renderer (auto, raw, helm, kustomize)"),
      helm: Console.OpenAPI.CD.RendererHelm,
    }
  }
end

defmodule Console.OpenAPI.CD.RendererHelm do
  @moduledoc """
  OpenAPI schema for renderer Helm configuration.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "RendererHelm",
    description: "Helm-specific configuration for a renderer",
    properties: %{
      values: string(description: "Helm values file content to use when rendering"),
      values_files: array_of(string(), description: "List of relative paths to values files"),
      release: string(description: "Helm release name to use when rendering"),
      ignore_hooks: boolean(description: "Whether to ignore Helm hooks when rendering"),
    }
  }
end

defmodule Console.OpenAPI.CD.ServiceSource do
  @moduledoc """
  OpenAPI schema for additional service sources.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "ServiceSource",
    description: "An additional source repository for a service deployment",
    properties: %{
      path: string(description: "Subdirectory path where this source will live in the final tarball"),
      repository_id: string(description: "ID of the git repository to source from"),
      git: Console.OpenAPI.Git,
    }
  }
end

defmodule Console.OpenAPI.CD.ServiceError do
  @moduledoc """
  OpenAPI schema for service deployment errors.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "ServiceError",
    description: "An error reported by the deployment operator during service sync",
    properties: %{
      source: string(description: "Source of the error (e.g., component name or sync stage)"),
      message: string(description: "Error message describing what went wrong"),
      warning: boolean(description: "If true, this is a warning rather than a fatal error"),
    }
  }
end

defmodule Console.OpenAPI.CD.HelmSpec do
  @moduledoc """
  OpenAPI schema for Helm configuration.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "HelmSpec",
    description: "Helm chart configuration for a service",
    properties: %{
      chart: string(description: "Helm chart name (e.g., \"nginx\")"),
      values: string(description: "Inline helm values for the helm chart"),
      version: string(description: "Helm chart version"),
      release: string(description: "Helm release name for the deployment"),
      url: string(description: "URL of the Helm chart repository"),
      values_files: array_of(string(), description: "List of referenced values.yaml files"),
      repository_id: string(description: "ID of the Helm repository for this chart"),
    }
  }
end

defmodule Console.OpenAPI.CD.Kustomize do
  @moduledoc """
  OpenAPI schema for Kustomize configuration.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "Kustomize",
    description: "Kustomize configuration for a service",
    properties: %{
      path: string(description: "Path to the kustomization.yaml or kustomize directory relative to the repository root"),
      enable_helm: boolean(description: "If true, Helm integration is enabled for Kustomize"),
    }
  }
end

defmodule Console.OpenAPI.CD.ServiceConfigurationInput do
  @moduledoc """
  OpenAPI schema for service configuration key-value pairs.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "ServiceConfigurationInput",
    description: "A configuration key-value pair for a service deployment. These are used as templating values when rendering service manifests.",
    properties: %{
      name: string(description: "The name/key of the configuration value"),
      value: string(description: "The value for this configuration key. If null, will remove this value"),
    },
    required: [:name]
  }
end

defmodule Console.OpenAPI.CD.ServiceInput do
  @moduledoc """
  OpenAPI schema for service deployment creation/update input.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "ServiceInput",
    description: "Input for creating or updating a service deployment",
    properties: %{
      name: string(description: "Desired name for the service"),
      namespace: string(description: "Target deployment namespace"),
      protect: boolean(description: "If true, marks the service as protected from accidental changes"),
      dry_run: boolean(description: "If true, does not actually apply any changes to the cluster"),
      repository_id: string(description: "ID of the backing repository for this service"),
      git: Console.OpenAPI.Git,
      helm: Console.OpenAPI.CD.HelmSpecInput,
      kustomize: Console.OpenAPI.CD.KustomizeInput,
      configuration: array_of(Console.OpenAPI.CD.ServiceConfigurationInput, description: "Configuration values to template into the service manifests. You must pass the full list of configuration inputs"),
      sources: array_of(Console.OpenAPI.CD.ServiceSourceInput, description: "Additional source repositories for this service"),
      renderers: array_of(Console.OpenAPI.CD.ServiceRendererInput, description: "Custom renderers for processing service manifests"),
    },
    required: [:name, :namespace]
  }
end

defmodule Console.OpenAPI.CD.ServiceRendererInput do
  @moduledoc """
  OpenAPI schema for service renderer input.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "ServiceRendererInput",
    description: "Input for a custom renderer configuration",
    properties: %{
      path: string(description: "Path within the repository where this renderer applies"),
      type: ecto_enum(Console.Schema.Service.RendererType, description: "Type of renderer (auto, raw, helm, kustomize)"),
      helm: Console.OpenAPI.CD.RendererHelmInput,
    },
    required: [:path, :type]
  }
end

defmodule Console.OpenAPI.CD.RendererHelmInput do
  @moduledoc """
  OpenAPI schema for renderer Helm configuration input.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "RendererHelmInput",
    description: "Helm-specific configuration input for a renderer",
    properties: %{
      values: string(description: "Helm values file content to use when rendering"),
      values_files: array_of(string(), description: "List of relative paths to values files"),
      release: string(description: "Helm release name to use when rendering"),
      ignore_hooks: boolean(description: "Whether to ignore Helm hooks when rendering"),
    }
  }
end

defmodule Console.OpenAPI.CD.ServiceSourceInput do
  @moduledoc """
  OpenAPI schema for service source input.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "ServiceSourceInput",
    description: "Input for an additional source repository",
    properties: %{
      path: string(description: "Subdirectory path where this source will live in the final tarball"),
      repository_id: string(description: "ID of the git repository to source from"),
      git: Console.OpenAPI.Git,
    }
  }
end

defmodule Console.OpenAPI.CD.HelmSpecInput do
  @moduledoc """
  OpenAPI schema for Helm configuration input.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "HelmSpecInput",
    description: "Helm chart configuration input",
    properties: %{
      values: string(description: "YAML configuration values for the Helm chart"),
      values_files: array_of(string(), description: "List of referenced values.yaml files to be used with the chart"),
      chart: string(description: "Name of the Helm chart to deploy"),
      version: string(description: "Version of the Helm chart"),
      release: string(description: "Desired Helm release name"),
      url: string(description: "Helm chart repository URL"),
      repository_id: string(description: "ID of a GitRepository to use for sourcing this helm chart"),
    }
  }
end

defmodule Console.OpenAPI.CD.KustomizeInput do
  @moduledoc """
  OpenAPI schema for Kustomize configuration input.
  """
  use Console.OpenAPI.Base

  defschema %{
    type: :object,
    title: "KustomizeInput",
    description: "Kustomize configuration input",
    properties: %{
      path: string(description: "Path to the kustomization.yaml or kustomize directory"),
      enable_helm: boolean(description: "Enable Helm support within Kustomize if true"),
    }
  }
end
