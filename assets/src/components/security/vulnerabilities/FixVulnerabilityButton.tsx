import {
  AiSparkleFilledIcon,
  ArrowTopRightIcon,
  Button,
  Card,
  CloseIcon,
  DiscoverIcon,
  Flex,
  FormField,
  IconFrame,
  Markdown,
} from '@pluralsh/design-system'
import { RunStatusChip } from 'components/ai/infra-research/details/InfraResearch'
import { useOutsideClick } from 'components/hooks/useOutsideClick'
import { SimplePopupMenu } from 'components/layout/HeaderPopupMenu'
import { GqlError } from 'components/utils/Alert'
import { EditableDiv } from 'components/utils/EditableDiv'
import { FillLevelDiv } from 'components/utils/FillLevelDiv'
import { StretchedFlex } from 'components/utils/StretchedFlex'
import { StackedText } from 'components/utils/table/StackedText'
import { InlineLink } from 'components/utils/typography/InlineLink'
import { Body2BoldP } from 'components/utils/typography/Text'
import {
  AgentRunFragment,
  AgentRunMode,
  VulnerabilityFragment,
  useCreateAgentRunMutation,
} from 'generated/graphql'
import { useRef, useState } from 'react'
import { Link } from 'react-router-dom'
import { getAgentRunAbsPath } from 'routes/aiRoutesConsts'
import { AI_SETTINGS_AGENT_RUNTIMES_ABS_PATH } from 'routes/settingsRoutesConst'
import styled, { useTheme } from 'styled-components'
import { AIAgentRuntimesSelector } from '../../ai/agent-runs/AIAgentRuntimesSelector'
import { AgentRunRepoSelector } from '../../ai/agent-runs/AgentRunRepoSelector'

// TODO: get initial prompt from vuln
const initialPrompt = ``

export function FixVulnerabilityButton({
  vuln: _vuln,
}: {
  vuln: VulnerabilityFragment
}) {
  const { colors } = useTheme()
  const [dropdownOpen, setDropdownOpen] = useState(false)
  const [prompt, setPrompt] = useState(initialPrompt)
  const menuBtnRef = useRef<HTMLButtonElement>(null)
  useOutsideClick(menuBtnRef, () => setDropdownOpen(false))

  const [agentRun, setAgentRun] = useState<AgentRunFragment | null>(null)

  return (
    <div css={{ position: 'relative', whiteSpace: 'nowrap' }}>
      <Button
        ref={menuBtnRef}
        onClick={() => setDropdownOpen((prev) => !prev)}
        startIcon={<AiSparkleFilledIcon />}
        disabled={!!dropdownOpen}
      >
        Fix vulnerability
      </Button>
      <FixVulnFormSC
        type="header"
        linkStyles={false}
        isOpen={dropdownOpen}
        setIsOpen={setDropdownOpen}
        fillLevel={1}
      >
        <StretchedFlex>
          <StackedText
            first="Fix vulnerability"
            firstPartialType="body1"
            firstColor="text-light"
            icon={<DiscoverIcon />}
            iconGap="xsmall"
          />
          <IconFrame
            clickable
            size="small"
            icon={<CloseIcon color={colors['icon-light']} />}
            onClick={() => setDropdownOpen(false)}
          />
        </StretchedFlex>
        {!!agentRun ? (
          <>
            <Flex
              direction="column"
              maxHeight={240}
              overflow="auto"
            >
              <Markdown text={prompt} />
            </Flex>
            <AgentRunInfoCard agentRun={agentRun} />
            <Button
              as={Link}
              to={getAgentRunAbsPath({ agentRunId: agentRun.id })}
              endIcon={<ArrowTopRightIcon />}
              alignSelf="end"
            >
              See progress
            </Button>
          </>
        ) : (
          <FixVulnerabilityForm
            prompt={prompt}
            setPrompt={setPrompt}
            setAgentRun={setAgentRun}
          />
        )}
      </FixVulnFormSC>
    </div>
  )
}

function FixVulnerabilityForm({
  prompt,
  setPrompt,
  setAgentRun,
}: {
  prompt: string
  setPrompt: (prompt: string) => void
  setAgentRun: (agentRun: AgentRunFragment) => void
}) {
  const [runtimeId, setRuntimeId] = useState<Nullable<string>>(null)
  const [repository, setRepository] = useState<string>('')

  const [mutation, { loading, error }] = useCreateAgentRunMutation({
    variables: {
      runtimeId: runtimeId ?? '',
      attributes: {
        prompt,
        mode: AgentRunMode.Write,
        repository,
      },
    },
    onCompleted: ({ createAgentRun }) =>
      createAgentRun && setAgentRun(createAgentRun),
  })

  const canSubmit = !!runtimeId && !!repository && !!prompt && !loading

  return (
    <>
      {error && <GqlError error={error} />}
      <FormField
        label="Select a runtime"
        caption={
          <InlineLink
            as={Link}
            to={AI_SETTINGS_AGENT_RUNTIMES_ABS_PATH}
            target="_blank"
          >
            Runtime settings
          </InlineLink>
        }
      >
        <FillLevelDiv fillLevel={2}>
          <AIAgentRuntimesSelector
            autoSelectDefault
            allowDeselect={false}
            selectedRuntimeId={runtimeId}
            setSelectedRuntimeId={setRuntimeId}
            outerStyles={{ width: '100%' }}
          />
        </FillLevelDiv>
      </FormField>
      <FormField label="Select a repository URL">
        <AgentRunRepoSelector
          selectedRepository={repository}
          setSelectedRepository={(repository) =>
            repository && setRepository(repository)
          }
          triggerButton={undefined}
          leftContent={undefined}
        />
      </FormField>
      <PromptInputBoxSC>
        <EditableDiv
          initialValue={prompt}
          setValue={setPrompt}
          placeholder="Create a PR to fix this vulnerability"
          disabled={loading}
          css={{ height: 140 }}
        />
      </PromptInputBoxSC>
      <Button
        disabled={!canSubmit}
        loading={loading}
        onClick={() => mutation()}
        alignSelf="end"
      >
        Attempt fix
      </Button>
    </>
  )
}

function AgentRunInfoCard({ agentRun }: { agentRun: AgentRunFragment }) {
  const { colors } = useTheme()
  return (
    <AgentRunStatusBoxSC>
      <Flex
        align="center"
        gap="small"
      >
        <DiscoverIcon
          size={16}
          color={colors['icon-default']}
        />
        <Body2BoldP>Started agent run</Body2BoldP>
      </Flex>
      <RunStatusChip
        status={agentRun.status}
        fillLevel={2}
      />
    </AgentRunStatusBoxSC>
  )
}

export const FixVulnFormSC = styled(SimplePopupMenu)(({ theme }) => ({
  width: 578,
  padding: theme.spacing.medium,
  gap: theme.spacing.large,
  transform: 'translateY(20px)',
}))

const PromptInputBoxSC = styled(Card)(({ theme }) => ({
  padding: `${theme.spacing.small}px ${theme.spacing.medium}px`,
  '&:focus-within': {
    border: theme.borders['outline-focused'],
  },
}))

const AgentRunStatusBoxSC = styled(Card)(({ theme }) => ({
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'space-between',
  padding: theme.spacing.medium,
}))
